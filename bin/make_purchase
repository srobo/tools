#!/usr/bin/env python
# coding=utf8

import sr.spending.spending as srspending
import sr.budget.budget as srbudget
import xmlrpclib, getpass, os, sys
from random import choice
from time import sleep

_SERVER = "studentrobotics.org"
_PORT = 443

if not (os.path.exists('.git') and os.path.exists('spending.py')):
	print >>sys.stderr, "Please run in spending.git top level directory"
	exit(1)

user = raw_input("Username: ")
supplier = raw_input("Supplier: ")
items = raw_input("Items to be purchased (item:cost,item:cost...): ")
purpose = raw_input("What are the items for?: ")
budget = raw_input("Budget line: ")

try:
	budgetline = srspending.load_budget_with_spending('.').path(budget)
except KeyError:
	print >>sys.stderr, "Budget line '" + budget + "' not found"
	exit()

spent = 0
for trans in budgetline.transactions:
	spent +=trans.cost

server = xmlrpclib.ServerProxy("".join(["https://",user,":",getpass.getpass(),"@",_SERVER,":",str(_PORT),"/trac/login/rpc"]))

if "ticket.create" not in server.system.listMethods():
	print "ARGH!"
	sleep(3)
	print "That'll be all"
	exit

description = ""

msg = ""
msg += "{{{Payee: " + str(user) + "}}}\n"
msg += "{{{Supplier: " + str(supplier) + "}}}\n"
msg += "{{{Items: }}}\n"
totalCost = 0
for item in items.split(','):
	i,j = item.split(':')
	totalCost += float(j.strip('£ '))
	msg += "  || " + i + ' || £' + j.strip('£ ') + "||\n" 
	description += i + ", "
msg += "{{{Total cost: £%.2f}}}\n" % totalCost
msg += "{{{Budget line: " + str(budget) + "}}}\n"

if float(spent) + totalCost > budgetline.cost:
	print "That purchase takes you over the budget limit"
	if not raw_input("Continue anyway? [y/N] ").lower() == 'y':
		exit()

name = ""
name += items.split(',')[0].split(':')[0].replace(" ","-")
if len(items.split(',')) > 1:
	name += '-and-'
	name += choice(items.split(',')[1:]).split(':')[0].replace(" ","-")
	if len(items.split(',')) > 2:
		name += '-etc'

summary = name.replace("-"," ") + " for " + purpose
name += ".yaml"

description = description.rstrip(', ')
description += " for " + purpose

ticketNum = server.ticket.create(summary, msg, {'component':"Purchasing",'owner':"treasurer",'type':"task"})

if not ticketNum > 0:
	print "Unable to create a valid ticket"
	exit()

spendName = os.path.join("pending",name)
spendFile = open(spendName, "w")

spendFile.write("summary: " + summary + '\n')
spendFile.write("description: >-\n  " + description + '\n')
spendFile.write("budget: " + budget + '\n')
spendFile.write("cost: " + str(totalCost) + '\n')
spendFile.write("trac: " + str(ticketNum) + '\n')

print "Purchase ready (trac: #" + str(ticketNum) + ")"
