#!/usr/bin/env python
# -*- coding: utf-8 -*-
import os
import sr.budget as budget
import sys, yaml
from decimal import Decimal as D, ROUND_UP

# Spending against a budget line is allowed to go over its value by
# this factor
FUDGE_FACTOR = D("1.1")

b = budget.load_budget( "./" )

try:
    f = open( "funds-in.yaml", "r" )
except IOError:
    if os.path.exists( "check" ):
        os.execv( "./check", ["./check"] + sys.argv[1:] )
    exit(1)

funds_in = yaml.load( f )

total_in = D(0)

for i in funds_in["incoming"]:
    # Convert to str to avoid some rounding issues!
    total_in += D( str(i["amount"]) )

MAX = total_in

budgeted = D(0)

for line in b.walk():
    c = line.cost

    if line.closed:
        """Budget lines that are closed need no breathing space."""
        c /= FUDGE_FACTOR
        # Round the result up for extra paranoia
        c = c.quantize(D("0.01"), rounding=ROUND_UP)

    budgeted += c

if budgeted > MAX:
    print >> sys.stderr, "Fail: Budget is £%s too high" % (budgeted - MAX)
    exit (1)

print "OK:",
if budgeted == MAX:
    print "Budget is at maximum."
else:
    print "Budget is £%s below maximum." % (MAX-budgeted)
